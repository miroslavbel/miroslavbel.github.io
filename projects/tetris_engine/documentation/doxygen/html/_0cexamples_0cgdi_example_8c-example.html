<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tetris-engine: \examples\gdi_example.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tetris-engine
   &#160;<span id="projectnumber">0.1.0</span>
   </div>
   <div id="projectbrief">Engine for tetris.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">\examples\gdi_example.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Пример для Windows GDI. Предполагает использования только одного треда.</p>
<div class="fragment"><div class="line"><span class="comment">// Example for one thread.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;Windows.h&gt;</span> <span class="comment">// example use windows-style message quenue</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="engine_8h.html">engine.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><a name="a0"></a><a class="code" href="engine_8h.html#a7b902392b363ea13489c0f3c30bb730e">GetNextTetrominoFunction</a> *<span class="keyword">const</span> ourGetNextTetrominoFunction;</div>
<div class="line"><a name="a1"></a><a class="code" href="engine_8h.html#a58bf8c10cbd16022e633508758d37ec5">GetScoreAddendFunction</a> *<span class="keyword">const</span> ourGetScoreAddendFunction;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// For simplicity of example we allow play only one time</span></div>
<div class="line"><span class="comment">// In this way before game creation it can be null. And</span></div>
<div class="line"><span class="comment">// after game creation it&#39;s always a valid ptr (we don&#39;t</span></div>
<div class="line"><span class="comment">// need atomic because now it is immutable).</span></div>
<div class="line"><a name="_a2"></a><a class="code" href="structtag_game.html">Game</a>* game = NULL;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">LRESULT CALLBACK WndProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> handler_paint(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> handler_keyDown(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> handler_timer(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">   <span class="comment">// GetModuleHandleW in a real app will be also needed or use cl compiler with WinMain-like entry point</span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">// allocate memory</span></div>
<div class="line">   game = <a name="a3"></a><a class="code" href="engine_8h.html#a0f7fe8fa919539d21f18357e7ae145a3">initGame</a>(10, 20, 1000, ourGetNextTetrominoFunction, ourGetScoreAddendFunction);</div>
<div class="line">   <span class="keywordflow">if</span> (!game)  { <a name="a4"></a><a class="code" href="engine_8h.html#a491341d547ffabcf60d3f41f3624c9e2">freeGame</a>(game); <span class="keywordflow">return</span> -1; } <span class="comment">//&lt; handle OutOfMemory error</span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">// create window with WNDCLASS::lpfnWndProc = WndProc</span></div>
<div class="line">   <span class="comment">// use RegisterClass, CreateWindow, ShowWindow, UpdateWindow</span></div>
<div class="line">   HWND hWnd = NULL;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// start game</span></div>
<div class="line">   <a name="a5"></a><a class="code" href="engine_8h.html#a7f0f70a79139b6c5c75a8fc5ae07ff93">startGame</a>(game);</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// SetTimer call</span></div>
<div class="line">   SetTimer(hWnd, 1, 500, NULL);</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// message quenue routine</span></div>
<div class="line">   MSG msg;</div>
<div class="line">   BOOL bRet;</div>
<div class="line">   <span class="keywordflow">while</span>( (bRet = GetMessageW(&amp;msg, NULL, 0, 0)) != 0) {</div>
<div class="line">      <span class="keywordflow">if</span> (bRet == -1) {</div>
<div class="line">         <span class="comment">// handle the error and possibly exit</span></div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">         TranslateMessage(&amp;msg); </div>
<div class="line">         DispatchMessageW(&amp;msg); </div>
<div class="line">      }</div>
<div class="line">   }</div>
<div class="line">   <a class="code" href="engine_8h.html#a491341d547ffabcf60d3f41f3624c9e2">freeGame</a>(game); <span class="comment">// do we really need it before call to ExitProcess?</span></div>
<div class="line">   <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">LRESULT CALLBACK WndProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {</div>
<div class="line">   <span class="keywordflow">switch</span> (uMsg) {</div>
<div class="line">      <span class="keywordflow">case</span> WM_PAINT:</div>
<div class="line">         handler_paint(hWnd, uMsg, wParam, lParam);</div>
<div class="line">         <span class="keywordflow">return</span> 0; <span class="comment">// an application should return zero if it processes WM_PAINT message</span></div>
<div class="line">      <span class="keywordflow">case</span> WM_KEYDOWN:</div>
<div class="line">         handler_keyDown(hWnd, uMsg, wParam, lParam);</div>
<div class="line">         <span class="keywordflow">return</span> 0; <span class="comment">// an application should return zero if it processes WM_KEYDOWN message</span></div>
<div class="line">      <span class="keywordflow">case</span> WM_TIMER:</div>
<div class="line">         mainWindowHandler_timer(wParam);</div>
<div class="line">         <span class="keywordflow">return</span> 0; <span class="comment">// an application should return zero if it processes WM_TIMER message</span></div>
<div class="line">      <span class="keywordflow">case</span> WM_CLOSE:</div>
<div class="line">        DestroyWindow(hWnd);</div>
<div class="line">        PostQuitMessage(0);</div>
<div class="line">        <span class="keywordflow">return</span> 0; <span class="comment">// an application should return zero if it processes WM_DESTROY message</span></div>
<div class="line">      <span class="keywordflow">default</span>:</div>
<div class="line">         <span class="keywordflow">return</span> DefWindowProcW(hWnd, uMsg, wParam, lParam);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> handler_paint(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {</div>
<div class="line">   <span class="keywordflow">for</span> (int8_t y = game-&gt;<a name="a6"></a><a class="code" href="structtag_game.html#af0859782c183dc68c028aa1428bf88c0">height</a> - 1; y &gt;= 0; --y) {</div>
<div class="line">      int8_t realY = game-&gt;<a class="code" href="structtag_game.html#af0859782c183dc68c028aa1428bf88c0">height</a> - 1 - y;</div>
<div class="line">      <span class="keywordflow">for</span> (int8_t x = 0; x &lt; game-&gt;<a name="a7"></a><a class="code" href="structtag_game.html#a82af63d50066dfc41384f1fe54fb7177">width</a>; ++x) {</div>
<div class="line">         <a class="code" href="engine_8h.html#afccf6453269215efe0ee139718b748c1">TetrominoPixel</a> tetrominoPixel = <a name="a8"></a><a class="code" href="engine_8h.html#ab7c856aafaf209fa4302b0d7f8780d37">flatArrayAs2D</a>(game-&gt;<a name="a9"></a><a class="code" href="structtag_game.html#a5c15998e8ddadb8ed1926be3f3062624">gameField</a>, x, y, game-&gt;<a class="code" href="structtag_game.html#a82af63d50066dfc41384f1fe54fb7177">width</a>);</div>
<div class="line">         <span class="comment">// if pixel not empty (not 0)</span></div>
<div class="line">         <span class="keywordflow">if</span> (tetrominoPixel) {</div>
<div class="line">            <span class="comment">// then draw</span></div>
<div class="line">            <span class="comment">// checkout, for example, https://docs.microsoft.com/en-us/windows/win32/gdi/rectangles</span></div>
<div class="line"> </div>
<div class="line">            <span class="comment">// remember we can use different TetrominoPixel values as colors</span></div>
<div class="line"> </div>
<div class="line">         }</div>
<div class="line">      }</div>
<div class="line">   }</div>
<div class="line">   <span class="comment">// draw the same way game-&gt;nextTetromino</span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">// draw game-&gt;score</span></div>
<div class="line">   <span class="comment">// checkout, for example, https://docs.microsoft.com/en-us/windows/win32/gdi/fonts-and-text</span></div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> handler_keyDown(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {</div>
<div class="line">   <span class="keywordtype">unsigned</span> isGameFieldChange;</div>
<div class="line">   <span class="comment">// check game-&gt;status</span></div>
<div class="line">   <span class="keywordflow">if</span> (game-&gt;<a name="a10"></a><a class="code" href="structtag_game.html#ac9a27578c28e28338b2b1ba1b8e98643">status</a> == <a name="a11"></a><a class="code" href="engine_8h.html#aa97153f36f52bba4f66950755914801ea8538b300d70d7160d61683cc7da03548">playGameStatus</a>) {</div>
<div class="line">      <span class="keywordflow">switch</span> (wParam) {</div>
<div class="line">         <span class="keywordflow">case</span> VK_LEFT:</div>
<div class="line">         <span class="keywordflow">case</span> 0x41: <span class="comment">// A</span></div>
<div class="line">            isGameFieldChange = <a name="a12"></a><a class="code" href="engine_8h.html#a2945ebd32bbb85230a2f46bb7ddadd2a">moveLeft</a>(game);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">         <span class="keywordflow">case</span> VK_RIGHT:</div>
<div class="line">         <span class="keywordflow">case</span> 0x44: <span class="comment">// D</span></div>
<div class="line">            isGameFieldChange = <a name="a13"></a><a class="code" href="engine_8h.html#af133fcf0471912bf4847e9743afbcbe6">moveRight</a>(game);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">         <span class="keywordflow">case</span> 0x51: <span class="comment">// Q</span></div>
<div class="line">            isGameFieldChange = <a name="a14"></a><a class="code" href="engine_8h.html#a629b486c34f9fab17af46e5c5cb23fc3">rotateAgainstClockwise</a>(game);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">         <span class="keywordflow">case</span> 0x45: <span class="comment">// E</span></div>
<div class="line">            isGameFieldChange = <a name="a15"></a><a class="code" href="engine_8h.html#a04e1f831b7a6fc51f1efd520cc39cc35">rotateClockwise</a>(game);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (!isGameFieldChange) {</div>
<div class="line">         <span class="comment">// send WM_PAINT</span></div>
<div class="line">         InvalidateRect(hWnd, NULL, FALSE);</div>
<div class="line">      }</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> handler_timer(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {</div>
<div class="line">   <span class="keywordtype">unsigned</span> status = <a name="a16"></a><a class="code" href="engine_8h.html#aded6a3d6c0eb926bb6c9a94b48a45d49">tick</a>(game);</div>
<div class="line">   <span class="keywordflow">if</span> (status == 2 || status == 3) {</div>
<div class="line">      <span class="comment">// game ends then kill the timer</span></div>
<div class="line">   } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">// success or fail (but we need to update screen because of </span></div>
<div class="line">      <span class="comment">//   nextTetromino move to activeTetramino and because</span></div>
<div class="line">      <span class="comment">//   the new nextTetromino was generated)</span></div>
<div class="line">      InvalidateRect(hWnd, NULL, FALSE);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="ttc" id="aengine_8h_html"><div class="ttname"><a href="engine_8h.html">engine.h</a></div></div>
<div class="ttc" id="aengine_8h_html_a04e1f831b7a6fc51f1efd520cc39cc35"><div class="ttname"><a href="engine_8h.html#a04e1f831b7a6fc51f1efd520cc39cc35">rotateClockwise</a></div><div class="ttdeci">unsigned rotateClockwise(Game *game)</div><div class="ttdoc">Если это возможно, поворачивает активное тетрамино по часовой стрелке.</div></div>
<div class="ttc" id="aengine_8h_html_a0f7fe8fa919539d21f18357e7ae145a3"><div class="ttname"><a href="engine_8h.html#a0f7fe8fa919539d21f18357e7ae145a3">initGame</a></div><div class="ttdeci">Game * initGame(int8_t width, int8_t height, int32_t maxScore, GetNextTetrominoFunction *const getNextTetrominoFunction, GetScoreAddendFunction *const getScoreAddendFunction)</div><div class="ttdoc">Инициализирует&amp;#160;игру.</div></div>
<div class="ttc" id="aengine_8h_html_a2945ebd32bbb85230a2f46bb7ddadd2a"><div class="ttname"><a href="engine_8h.html#a2945ebd32bbb85230a2f46bb7ddadd2a">moveLeft</a></div><div class="ttdeci">unsigned moveLeft(Game *game)</div><div class="ttdoc">Если это возможно, двигает активное тетрамино влево.</div></div>
<div class="ttc" id="aengine_8h_html_a491341d547ffabcf60d3f41f3624c9e2"><div class="ttname"><a href="engine_8h.html#a491341d547ffabcf60d3f41f3624c9e2">freeGame</a></div><div class="ttdeci">void freeGame(Game *game)</div><div class="ttdoc">Освобождает игру.</div></div>
<div class="ttc" id="aengine_8h_html_a58bf8c10cbd16022e633508758d37ec5"><div class="ttname"><a href="engine_8h.html#a58bf8c10cbd16022e633508758d37ec5">GetScoreAddendFunction</a></div><div class="ttdeci">uint32_t GetScoreAddendFunction(int8_t cleanedLines)</div><div class="ttdoc">Вычисляет&amp;#160;количество&amp;#160;очков,&amp;#160;которое&amp;#160;игрок заработал за заполнение строк.</div><div class="ttdef"><b>Definition:</b> engine.h:116</div></div>
<div class="ttc" id="aengine_8h_html_a629b486c34f9fab17af46e5c5cb23fc3"><div class="ttname"><a href="engine_8h.html#a629b486c34f9fab17af46e5c5cb23fc3">rotateAgainstClockwise</a></div><div class="ttdeci">unsigned rotateAgainstClockwise(Game *game)</div><div class="ttdoc">Если это возможно, поворачивает активное тетрамино против часовой стрелки.</div></div>
<div class="ttc" id="aengine_8h_html_a7b902392b363ea13489c0f3c30bb730e"><div class="ttname"><a href="engine_8h.html#a7b902392b363ea13489c0f3c30bb730e">GetNextTetrominoFunction</a></div><div class="ttdeci">void GetNextTetrominoFunction(NextTetromino *nextTetromino)</div><div class="ttdoc">Генерирует&amp;#160;следующее&amp;#160;тетрамино.</div><div class="ttdef"><b>Definition:</b> engine.h:157</div></div>
<div class="ttc" id="aengine_8h_html_a7f0f70a79139b6c5c75a8fc5ae07ff93"><div class="ttname"><a href="engine_8h.html#a7f0f70a79139b6c5c75a8fc5ae07ff93">startGame</a></div><div class="ttdeci">void startGame(Game *game)</div><div class="ttdoc">Запускает игру.</div></div>
<div class="ttc" id="aengine_8h_html_aa97153f36f52bba4f66950755914801ea8538b300d70d7160d61683cc7da03548"><div class="ttname"><a href="engine_8h.html#aa97153f36f52bba4f66950755914801ea8538b300d70d7160d61683cc7da03548">playGameStatus</a></div><div class="ttdeci">@ playGameStatus</div><div class="ttdoc">Игра идет.</div><div class="ttdef"><b>Definition:</b> engine.h:209</div></div>
<div class="ttc" id="aengine_8h_html_ab7c856aafaf209fa4302b0d7f8780d37"><div class="ttname"><a href="engine_8h.html#ab7c856aafaf209fa4302b0d7f8780d37">flatArrayAs2D</a></div><div class="ttdeci">#define flatArrayAs2D(array, x, y, width)</div><div class="ttdoc">Позволяет обращаться к одномерному массиву как к двухмерному массиву по координатам x и y.</div><div class="ttdef"><b>Definition:</b> engine.h:67</div></div>
<div class="ttc" id="aengine_8h_html_aded6a3d6c0eb926bb6c9a94b48a45d49"><div class="ttname"><a href="engine_8h.html#aded6a3d6c0eb926bb6c9a94b48a45d49">tick</a></div><div class="ttdeci">unsigned tick(Game *game)</div><div class="ttdoc">Имплементриует тик.</div></div>
<div class="ttc" id="aengine_8h_html_af133fcf0471912bf4847e9743afbcbe6"><div class="ttname"><a href="engine_8h.html#af133fcf0471912bf4847e9743afbcbe6">moveRight</a></div><div class="ttdeci">unsigned moveRight(Game *game)</div><div class="ttdoc">Если это возможно, двигает активное тетрамино вправо.</div></div>
<div class="ttc" id="aengine_8h_html_afccf6453269215efe0ee139718b748c1"><div class="ttname"><a href="engine_8h.html#afccf6453269215efe0ee139718b748c1">TetrominoPixel</a></div><div class="ttdeci">uint8_t TetrominoPixel</div><div class="ttdoc">Пиксел тетрамино.</div><div class="ttdef"><b>Definition:</b> engine.h:97</div></div>
<div class="ttc" id="astructtag_game_html"><div class="ttname"><a href="structtag_game.html">tagGame</a></div><div class="ttdoc">Сама игра.</div><div class="ttdef"><b>Definition:</b> engine.h:224</div></div>
<div class="ttc" id="astructtag_game_html_a5c15998e8ddadb8ed1926be3f3062624"><div class="ttname"><a href="structtag_game.html#a5c15998e8ddadb8ed1926be3f3062624">tagGame::gameField</a></div><div class="ttdeci">TetrominoPixelArray const gameField</div><div class="ttdoc">Одномерный массив пикселов тетрамино игрового стакана.</div><div class="ttdef"><b>Definition:</b> engine.h:261</div></div>
<div class="ttc" id="astructtag_game_html_a82af63d50066dfc41384f1fe54fb7177"><div class="ttname"><a href="structtag_game.html#a82af63d50066dfc41384f1fe54fb7177">tagGame::width</a></div><div class="ttdeci">const int8_t width</div><div class="ttdoc">Ширина игрового стакана в пикселах.</div><div class="ttdef"><b>Definition:</b> engine.h:234</div></div>
<div class="ttc" id="astructtag_game_html_ac9a27578c28e28338b2b1ba1b8e98643"><div class="ttname"><a href="structtag_game.html#ac9a27578c28e28338b2b1ba1b8e98643">tagGame::status</a></div><div class="ttdeci">GameStatus status</div><div class="ttdoc">Состояние игры.</div><div class="ttdef"><b>Definition:</b> engine.h:228</div></div>
<div class="ttc" id="astructtag_game_html_af0859782c183dc68c028aa1428bf88c0"><div class="ttname"><a href="structtag_game.html#af0859782c183dc68c028aa1428bf88c0">tagGame::height</a></div><div class="ttdeci">const int8_t height</div><div class="ttdoc">Высота игрового стакана в пикселах.</div><div class="ttdef"><b>Definition:</b> engine.h:240</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
